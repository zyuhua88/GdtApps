
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>AddUsers</title>
    <link href="~/css/layui.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/layui.js"></script>
    <script src="~/js/zagJs.js"></script>

    <style>
        html, body {
            background: #F0F0F0;
            width: 100%;
            height: 100%
        }
    </style>
</head>
<body>
    <div class="layui-fluid" style="background:#fff;width:90%;height:auto; min-height:90%;margin:2% auto;padding:20px 20px"> 
        <form class="layui-form  layui-form-pane" lay-filter="form" style="width:100%;max-width:960px;margin:0 auto">
            <div class="layui-row layui-col-space10">
                <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                    <div class="layui-form-item">
                        <label class="layui-form-label">所在集团</label>
                        <div class="layui-input-block">
                            <input type="text" name="head_name" class="layui-input" readonly>
                        </div>
                    </div>
                </div>

                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">公司（厂）</label>
                        <div class="layui-input-block">
                            <select name="com_id" id="com_id" lay-filter="com_id"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">部门/项目</label>
                        <div class="layui-input-block">
                            <select name="b_id" id="b_id" lay-filter="b_id"></select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">班组</label>
                        <div class="layui-input-block">
                            <select name="c_id" id="c_id"></select>
                        </div>
                    </div>
                </div>

                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">登录名设置</label>
                        <div class="layui-input-block">
                            <input type="text" name="login_name" required lay-verify="required|email" placeholder="用户账号为电子邮箱" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">密码设置</label>
                        <div class="layui-input-block">
                            <input type="text" name="login_pwd" required lay-verify="required" placeholder="请输入用户登录密码" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">真实姓名</label>
                        <div class="layui-input-block">
                            <input type="text" name="real_name" required lay-verify="required" placeholder="请输入真实姓名" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">职务</label>
                        <div class="layui-input-block">
                            <select name="position">
                                <option value="董事长">董事长</option>
                                <option value="总经理">总经理</option>
                                <option value="分公司总经理">分公司总经理</option>
                                <option value="主任">主任</option>
                                <option value="部门经理">部门经理</option>
                                <option value="项目经理">项目经理</option>
                                <option value="安全经理">安全经理</option>
                                <option value="安全工程师">安全工程师</option>
                                <option value="安全员">安全员</option>
                                <option value="承包商负责人">承包商负责人</option>
                                <option value="一般员工">一般员工</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">性别</label>
                        <div class="layui-input-block">
                            <input type="radio" name="gender" value="1" title="男" checked>
                            <input type="radio" name="gender" value="0" title="女">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">出生日期</label>
                        <div class="layui-input-block">
                            <input type="text" name="age" class="layui-input" id="age" readonly>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">身份证号</label>
                        <div class="layui-input-block">
                            <input type="text" name="us_no" placeholder="请输入身份证号码" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">手机号码</label>
                        <div class="layui-input-block">
                            <input type="text" name="mobile" required lay-verify="required|phone" placeholder="请输入手机号码" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm6 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">公司座机</label>
                        <div class="layui-input-block">
                            <input type="text" name="tel" placeholder="请输入座机号码" autocomplete="off" class="layui-input hides">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm8 layui-col-md8">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">工作状态</label>
                        <div class="layui-input-block">
                            <input type="radio" name="work_state" value="0" title="离职">
                            <input type="radio" name="work_state" value="1" title="在职" checked>
                            <input type="radio" name="work_state" value="2" title="请假">
                            <input type="radio" name="work_state" value="3" title="内退">
                            <input type="radio" name="work_state" value="4" title="退休">
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm4 layui-col-md4">
                    <div class="layui-form-item">
                        <label class="layui-form-label">用户级别</label>
                        <div class="layui-input-block">
                            <select name="verify" id="verify">
                                <option value="0">安全总监（公司）</option>
                                <option value="1">项目经理（项目）</option>
                                <option value="2">安全理员/员（项目）</option>
                                <option value="3">承包商负责人（班组）</option>
                                <option value="4">一般员工（个人）</option>
                            </select>
                        </div>
                    </div>
                </div>

                
                <div class="layui-col-xs12 layui-col-sm4 layui-col-md4 card">
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">三级教育</label>
                        <div class="layui-input-block">
                            <input type="radio" name="markcard" lay-filter="markcard" value="0" title="不创建">
                            <input type="radio" name="markcard" lay-filter="markcard" value="1" title="创建" checked>
                        </div>
                    </div>
                </div>
                <div class="layui-col-xs12 layui-col-sm4 layui-col-md4 card" id="end_times">
                    <div class="layui-form-item">
                        <label class="layui-form-label">过期日期</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" id="end_time" name="end_time" readonly>
                        </div>
                    </div>
                </div>

                <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                    <blockquote class="layui-elem-quote" style="color:#ff6a00;cursor:pointer" id="selectHelp">怎么选择用户级别？<span class="layui-icon"> &#xe607;</span> 过期时间，如果创建的三级教育卡为永久有效，请保持为空</blockquote>
                </div>


                <div class="layui-col-xs12 layui-col-sm12 layui-col-md12">
                    <div class="layui-form-item">
                        <div class="layui-input-block" style="text-align:right">
                            <button class="layui-btn" lay-submit lay-filter="send"><i class="layui-icon">&#xe654;</i> 立即提交</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
    </div>


    <div class="layer_notice" style="width:96%;height:auto;color:#fff;background:#5FB878;padding:20px 2%">
        1、系统管理员：系统管理员享有集团公司所有权限;<br />
        2、公司（厂）级管理员：为公司（厂）级最高级别权限；<br />
        3、部门（项目）级管理员：部门（项目）级最高权限，特殊权限有，当企业安全管理员/安全员，在现场发现的安全隐患或对班组出的整改意见，系统将默认发送给该权限所有者，并由该权限所有者审核通过后，提交至整改对象；<br />
        4、班组管理员：为班组最高权限。负责对班级员工的管理及信息上报工作，并有权添加其班组员工信息<br />
        5、一般员工：可信息上报、隐患上报、在线考试及学员；<br />
        注：1-4级管理员在系统内均享受一般员工的功能！
    </div>
    <script>
        var userInfo = parent.userInfo;
        var configUrl = parent.configUrl;
        var us_id = "@ViewBag.us_id";
        //如果us_id存在，说明是修改员工信息
        //隐藏添加三级教育卡片的功能
        if (us_id != "") {
            $(".card").css("display", "none");
        }

        
        

        layui.use(["form", "layer","laydate"], function () {
            var form = layui.form
                , layer = layui.layer
                , laydate = layui.laydate;
            
            var laydate = layui.laydate;
            //0集团安全  1公司安全总监  2项目/ 安全经理  3承包商负责人  4一般员工
            if (userInfo.data[0].verify == 0) {
                $("#verify").html('<option value="0">集团安全</option>'+
                    '<option value= "1"> 公司安全总监</option>'+
                    '<option value="2">项目/ 安全经理</option>' +
                    '<option value="3">承包商负责人</option>' +
                    '<option value="4">一般员工</option>');
            }
            if (userInfo.data[0].verify == 1) {
                $("#verify").html('<option value= "1"> 公司安全总监</option>' +
                    '<option value="2">项目/ 安全经理</option>' +
                    '<option value="3">承包商负责人</option>' +
                    '<option value="4">一般员工</option>');
            }
            if (userInfo.data[0].verify == 2) {
                $("#verify").html('<option value="2">项目/ 安全经理</option>' +
                    '<option value="3">承包商负责人</option>' +
                    '<option value="4">一般员工</option>');
            }
            if (userInfo.data[0].verify == 3) {
                $("#verify").html('<option value="3">承包商负责人</option>' +
                    '<option value="4">一般员工</option>');
            }
            if (userInfo.data[0].verify == 4) {
                $("#verify").html('');
            }
            form.render("select");
            
            

            //执行一个laydate实例  三级教育的过期日期
            laydate.render({
                elem: '#end_time' //指定元素
            });


            ///监听是否创建三级教育卡的选项
            form.on("radio(markcard)", function (obj) {
                if (obj.value == 0) {
                    $("#end_times").fadeOut(100);
                } else {
                    $("#end_times").fadeIn(100);
                }
            });

            $("#selectHelp").on("click", function () {
                layer.open({
                    type: 1,
                    shade: false,
                    title: false, //不显示标题
                    content: $('.layer_notice'), //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                    area: "96%",
                    cancel: function () {

                    }
                });
            });
            

            var date = new Date();
            laydate.render({
                elem: "#age",
                value: (date.getFullYear() - 18) + "-" + (date.getMonth() + 1) + "-" + date.getDate()
            });
            //console.log(userInfo);
            form.val("form", {
                "head_name": userInfo.data[0].head_name
            });
            form.render();

            ////加载子公司列表
            $.ajax({
                url: configUrl + "/api/headoffice/gdt/QueryCompany?head_id=" + userInfo.data[0].head_id + "&com_id=" + userInfo.data[0].com_id + "&verify=" + userInfo.data[0].verify,
                type: "post",
                contentType: "application/json",
                async: false,
                success: function (res) {
                    //alert(JSON.stringify(res));
                    //console.log(res);
                    var comhtml = '<option value="0">集团所属员工</option>';
                    for (var i = 0; i < res.data.length; i++) {
                        comhtml += '<option value="' + res.data[i].com_id + '">' + res.data[i].com_name + '</option>';
                    }
                    $("#com_id").html(comhtml);
                    //如果登录员工权限为公司或公司以下
                    if (userInfo.data[0].verify >= 1) {
                        form.val("form", {
                            "com_id": "" + userInfo.data[0].com_id
                        });
                        $("#com_id").find("option").attr("disabled", true);
                        com(userInfo.data[0].com_id);
                    }
                    form.render("select");
                }
            });

            if (us_id != "" && us_id != null) {
                //$("#reset").fadeOut(10);
                layer.load();
                $.ajax({
                    url: configUrl + "/api/users/gdt/queryuser?us_id=" + us_id,
                    type: "post",
                    contentType: "application/json",
                    async: false,
                    success: function (res) {
                        //console.log(res.data);
                        var data = res.data[0];
                        com(data.com_id);
                        deparment(data.b_id);
                        form.val("form", {
                            "age": "" + timestampToTime2(data.age),
                            "b_id": "" + data.b_id,
                            "c_id": "" + data.c_id,
                            "com_id": "" + data.com_id,
                            "gender": "" + data.gender,
                            "login_name": "" + data.login_name,
                            "login_pwd": "" + data.login_pwd,
                            "mobile": "" + data.mobile,
                            "position": "" + data.position,
                            "real_name": "" + data.real_name,
                            "tel": "" + data.tel,
                            "us_no": "" + data.us_no,
                            "work_state": "" + data.work_state,
                            "verify":""+data.verify
                        });

                        laydate.render({
                            elem: "#age",
                            value: timestampToTime2(data.age)
                        });
                        form.render();
                        
                    }
                });
                layer.closeAll("loading");
            } 

            

            /////监听子公司的值改变
            form.on("select(com_id)", function (data) {
                var com_id = data.value;
                com(com_id);
            });

            function com(com_id) {
                var bhtml = '<option value="0">子公司所属员工</option>';
                if (com_id == 0) {
                    bhtml = '<option value="0">无选择项</option>';
                } else {
                    $.ajax({
                        url: configUrl + "/api/company/gdt/querydeparment?com_id=" + com_id,
                        type: "post",
                        contentType: "application/json",
                        async: false,
                        success: function (res) {
                            for (var i = 0; i < res.data.length; i++) {
                                bhtml += '<option value="' + res.data[i].b_id + '">' + res.data[i].b_name + '</option>';
                            }
                            $("#b_id").html(bhtml);
                            //如果登录员工为部门或部门以下权限
                            if (userInfo.data[0].verify > 1) {
                                deparment(userInfo.data[0].b_id);
                                form.val("form", {
                                    "b_id": "" + userInfo.data[0].b_id
                                });
                                $("#b_id").find("option").attr("disabled", true);
                            }
                            form.render("select");
                        }
                    });
                }
            }

            ////监听部门的值改变 选择班组
            form.on("select(b_id)", function (data) {
                var b_id = data.value;
                deparment(b_id);
            });

            function deparment(b_id) {
                //alert(b_id);
                var bhtml = '<option value="0">部门所属员工</option>';
                if (b_id == 0) {
                    bhtml = '<option value="0">无选择项</option>';
                } else {
                    $.ajax({
                        url: configUrl + "/api/deparment/gdt/query?b_id=" + b_id,
                        type: "post",
                        contentType: "application/json",
                        async: false,
                        success: function (res) {
                            for (var i = 0; i < res.data.length; i++) {
                                bhtml += '<option value="' + res.data[i].c_id + '">' + res.data[i].c_name + '</option>';
                            }
                            $("#c_id").html(bhtml);
                            //如果登录员工为班组或班组以下权限
                            if (userInfo.data[0].verify > 2) {
                                $("#c_id").find("option").attr("disabled", true);
                                form.val("form", {
                                    "c_id": "" + userInfo.data[0].c_id
                                });
                            }
                            form.render("select");
                        }
                    });
                }
            }

            

            ///添加用户信息
            form.on("submit(send)", function (obj) {
                obj.field.head_id = userInfo.data[0].head_id;
                if (obj.field.c_id=="") {
                    obj.field.c_id = 0;
                }

                console.log(obj.field);
                layer.load();
                var usl = configUrl + "/api/users/gdt/addusers";
                
                if (us_id != "" && us_id != null) {
                    usl = configUrl + "/api/users/gdt/changeusers?us_id=" + us_id;
                }
                ////开始上传用户的基本信息 用户名 密码 真实姓名
                $.ajax({
                    url: usl,
                    type: "post",
                    contentType: "application/json",
                    data: JSON.stringify(obj.field),
                    success: function (res) {
                        
                        if (res.code == 0) {
                            //上传用户的详情信息
                            var usid = res.usid;
                            var usl2 = configUrl + "/api/users/gdt/adduser_detail?usid=" + usid;
                            if (us_id != "" && us_id != null) {
                                usl2 = configUrl + "/api/users/gdt/changeuser_detail?us_id=" + us_id;
                            }
                            $.ajax({
                                url: usl2,
                                type: "post",
                                contentType: "application/json",
                                data: JSON.stringify(obj.field),
                                success: function (req) {
                                    layer.closeAll("loading");
                                    if (req.code == 0) {
                                        parent.getdate(parent.head_id, parent.com_id, parent.b_id, parent.c_id, parent.value, parent.page);
                                        layer.msg(req.msg, { icon: 1 }, function () {
                                            if (us_id != "" && us_id != null) {////如果为修改员工信息  执行关闭
                                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                                parent.layer.close(index); //再执行关闭
                                            } else {////如果为添加用户信息 执行清除表单元素里的内容
                                                $(".hides").val("");
                                            }
                                        });
                                    } else {
                                        layer.msg(req.msg, {icon:2});
                                    }
                                }
                            });
                        } else {
                            layer.closeAll("loading");
                            layer.msg(res.msg, {icon:2})
                        }
                    }
                });
                return false;
            })
        });
    </script>
</body>
</html>
